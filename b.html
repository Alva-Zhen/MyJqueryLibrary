<!DOCTYPE html>
<html lang="zh-CH">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>产品管理</title>
</head>

<body>
    <!-- 菜单条 -->
    <div class="box">
        <div class="box-con">
            <div class="box-header">
                <p>
                    <span>产品列表</span>
                    <span>
                        <span class="all-counts"></span> Product</span>
                </p>

                <div class="search-menu search-menu-random">
                    <div>
                        <div class="search">
                            <span>产品名称</span>
                            <input type="text" id="product-name">
                        </div>
                    </div>
                    <div>
                        <div class="search">
                            <span>产品编码</span>
                            <input type="text" id="product-code">
                        </div>
                    </div>
                    <div>
                        <span>产品状态</span>
                        <select class="drop default-select" id="product-status"></select>
                        <p class="tip orderStatus-tip">请选择的产品状态！</p>
                    </div>
                    <div>
                        <span>产品类型</span>
                        <select class="drop default-select" id="product-type">
                            <option value="">全部</option>
                        </select>
                        <p class="tip orderStatus-tip">请选择的产品类型！</p>
                    </div>
                    <div>
                        <button class="inquiry" id="product-search">查询</button>
                    </div>

                </div>

            </div>

            <div>
                <div class="options">
                    <img class="options-add" type="0" src="./img/Icon-add.png" alt="" title="新增">
                    <img class="options-add" type="1" src=" ./img/combination.png" alt="" title="新增组合产品">
                    <img class="options-delete" src="./img/Icon-delet.png" alt="" title="删除">
                    <img class="options-recover" src="./img/recover.png" alt="" title="恢复">
                    <img class="options-online" src="./img/Icon-online.png" alt="" title="上线">
                    <img class="options-outline" src="./img/Icon-outline.png" alt="" title="下线">
                    <!-- <img src="./img/Icon-checkno.png" alt="" title="新增"> -->
                </div>
                <div id="product-table"></div>
            </div>

            <div class="combo-detail _scroll" id="combo-detail">
                <div class="combo-detail-con _panel-box"></div>
            </div>

        </div>
        <div class="page">
            <div class="pre"></div>
            <p>Page
                <span>2</span> of
                <span>3</span>
                <select id="page-select">
                    <option selected="selected" value="10">每页显示：10条</option>
                    <option value="9">每页显示：9条</option>
                    <option value="8">每页显示：8条</option>
                    <option value="7">每页显示：7条</option>
                </select>
            </p>
            <div class="next"></div>
        </div>

    </div>

    <!-- 新建产品 -->
    <div class="box new-product">
        <div class="box-header">
            <p>
                <span class="pop-header-box">新建产品</span>
                <span>New Product</span>
            </p>
        </div>
        <div class="box-con" style="border: none;">
            <div class="colum-2 height100">
                <div>
                    <div class="formDiv">
                        <div class="productNumber-wrap">
                            <label>产品编码：</label>
                            <input class="form-productNumber readonly" type="text" name="" id="product-code" readonly>
                            <p class="tip product-code-tip">请填写产品编码！</p>
                        </div>
                        <div>
                            <label>地区编号：</label>
                            <input class="form-areaNumber  default-select" type="text" name="" id="regionCode">
                            <p class="tip regionCode-tip">请填写地区代码！</p>
                        </div>
                        <div>
                            <label>产品名称：</label>
                            <input class="form-productName" type="text" name="" id="productName" maxlength="20">
                            <p class="tip productName-tip">请填写产品名称！</p>
                        </div>
                        <div>
                            <label for="">产品类型：</label>
                            <select class="form-productType default-select" id="productType"></select>
                            <p class="tip productType-tip">请选择产品类型！</p>
                        </div>
                        <div class="search-select">
                            <label for="">审批人：</label>
                            <input class="auditor" type="text" name="" id="auditor" maxlength="20">
                            <p class="tip auditor-tip">请选择审批人！</p>
                        </div>
                        <div>
                            <div class="datepicker" id="calendar">
                                <label>截止日期：</label>
                                <input class="form-endTime" type="text" id="endDate">
                                <i class="fa fa-calendar">
                                    <img src="./img/calendar.png" alt=" ">
                                </i>
                                <p class="tip endDate-tip">请选择截至日期：</p>
                            </div>
                        </div>
                        <div class="search-select">
                            <label for="">供应商：</label>
                            <input class="supplier default-select" type="text" name="" id="supplier" maxlength="20">
                            <p class="tip supplier-tip">请选择供应商！</p>
                        </div>
                    </div>
                </div>
                <div class="r height100">
                    <div class="combo-list-scroll _scroll">
                        <div class="combo-list-wrap  _panel-box">
                            <!-- <div class="formDiv combo-list">
                                <div>
                                    <label>套餐名称：</label>
                                    <input type="text" name=" " class="comboName" maxlength="20 ">
                                    <p class="tip comboName-tip">套餐名称不能为空！</p>
                                </div>
                                <div>
                                    <label>套餐代码：</label>
                                    <input type="text" name=" " class="comboCode" maxlength="50">
                                    <p class="tip comboCode-tip">套餐代码不能为空！</p>
                                </div>
                                 <div>
                                    <label>套餐转换代码：</label>
                                    <input type="text" name=" " class="comboTransCode" maxlength="50">
                                    <p class="tip comboTransCode-tip">套餐转换代码不能为空！</p>
                                </div> 
                                <div>
                                    <label>套餐价格：</label>
                                    <input type="text" name=" " class="comboPrice">
                                    <p class="tip comboPrice-tip">产品价格：不能为空！</p>
                                </div>
                                <div>
                                    <label for=" ">套餐税目：</label>
                                    <select class="default-select taxType" id="taxType"></select>
                                    <p class="tip taxType-tip ">请选择产品类型：</p>
                                </div>
                                <div>
                                    <label for=" ">套餐税种：</label>
                                    <select class="default-select taxCategory"></select>
                                    <p class="tip productType-code-tip ">请选择产品类型：</p>
                                </div>
                                <div>
                                    <label for=" ">套餐税率：</label>
                                    <input type="text" name=" " class="comboPrice readonly" readonly />
                                    <p class="tip productType-code-tip ">请选择产品税率！</p>
                                </div>
                                <div>
                                    <label for=" ">分成比例：</label>
                                    <input type="text" name=" " id="divideRatio" />
                                    <p class="tip divideRatio-tip ">请填写分成比例！</p>
                                </div>
                            </div> -->
                        </div>
                    </div>
                    <div class="form-opration ">
                        <!-- <img src="./img/Icon-delet.png " alt=" " class="delete2"> -->
                        <img src="./img/Icon-add.png " alt=" " class="combo-add">
                    </div>
                </div>
            </div>

        </div>
        <div class="btn-connected ">
            <button class="save-btn">保存新增</button>
            <button class="cancel-btn">取消新建</button>
        </div>
    </div>

    <!-- 新建组合产品 -->
    <div class="box box-add-new new-combination-product">
        <div class="box-header">
            <p>
                <span class="pop-header-box">新建组合产品</span>
                <span>New Product</span>
            </p>
        </div>
        <div class="box-con" style="border: none;">
            <div class="colum-2 height100">
                <div>
                    <div class="formDiv">
                        <div class="productNumber-wrap">
                            <label>产品编码：</label>
                            <input class="form-productNumber readonly" type="text" name="" id="combination-product-code"
                                readonly>
                            <p class="tip product-code-tip">请填写产品编码！</p>
                        </div>

                        <div>
                            <label>地区编号：</label>
                            <input class="form-areaNumber default-select" type="text" name="" id="combination-regionCode">
                            <p class="tip combination-regionCode-tip">请填写地区代码！</p>
                        </div>
                        <div>
                            <label>产品名称：</label>
                            <input class="form-productName" type="text" name="" id="combination-productName" maxlength="20">
                            <p class="tip combination-productName-tip">请填写产品名称！</p>
                        </div>
                        <div>
                            <label for="">产品类型：</label>
                            <select class="form-productType default-select" id="combination-productType"></select>
                            <p class="tip combination-productType-tip">请选择产品类型！</p>
                        </div>
                        <div>
                            <div class="datepicker" id="combination-calendar">
                                <label>截止日期：</label>
                                <input class="form-endTime" type="text" id="combination-endDate">
                                <i class="fa fa-calendar">
                                    <img src="./img/calendar.png" alt=" ">
                                </i>
                                <p class="tip combination-endDate-tip">请选择截至日期：</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="r height100">
                    <div class="combo-list-scroll _scroll">
                        <div class="combo-list-wrap  _panel-box">
                            <div class="formDiv combo-list">
                                <div>
                                    <label>产品：</label>
                                    <input type="text" name=" " id="combination-product-drop" class="comboName default-select">
                                </div>
                                <div>
                                    <label>套餐：</label>
                                    <div class="dropdwon" id="combination-product-combo">
                                        <div class="dropdwon-header default-select"></div>
                                        <ul></ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-opration ">
                        <!-- <img src="./img/Icon-delet.png " alt=" " class="delete2"> -->
                        <img src="./img/Icon-add.png " alt=" " class="combo-add">
                    </div>
                </div>
            </div>

        </div>
        <div class="btn-connected ">
            <button class="combination-save-btn">保存新增</button>
            <button class="cancel-btn">取消</button>
        </div>
    </div>

    <script>

        $(function () {
            //分页
            page(function (data) {
                creatTable(data)
            })

            var comboList = [];//套餐集合
            $('#calendar').calendar();
            $('#combination-calendar').calendar();

            newScroll()//生成滚动条

            creatTable();
            creatTax();

            auditorSearch()
            /* 区域模糊搜索 */
            $.selectSuggest('regionCode', createAreas());
            $.selectSuggest('combination-regionCode', createAreas());
            /* 关闭套餐详细 */
            $(document).click(function () {
                $('.combo-detail').removeClass('show-detail');
            });

            // 供应商
            supplier()

            function supplier() {
                ajaxAPI('../common/listProductSupplier', {}, function (res) {
                    $.selectSuggest('supplier', res.data);
                }, false)
            }


            $('.combo-add').click(function () {
                $('save-btn').attr('type', 'add')
                var str = '<div class="formDiv combo-list">' +
                    '<div><img src="./img/Icon-delet.png" class="remove-combo"></div>' +
                    '<div>' +
                    '<label>套餐名称：</label>' +
                    '<input type="text" name=" " class="comboName" maxlength="20 ">' +
                    '<p class="tip comboName-tip">套餐名称不能为空！</p>' +
                    '</div>' +
                    '<div>' +
                    '<label>套餐代码：</label>' +
                    '<input type="text" name=" " class="comboCode" maxlength="20 ">' +
                    '<p class="tip comboCode-tip">套餐代码不能为空！</p>' +
                    '</div>' +
                    '<div>' +
                    '<label>套餐价格：</label>' +
                    '<input type="text" name=" " class="comboPrice">' +
                    '<p class="tip comboPrice-tip">产品价格不能为空！</p>' +
                    '</div>' +
                    '<div>' +
                    '<label for=" ">套餐税目</label>' +
                    '<select class="default-select taxType" id="taxType"></select>' +
                    '<p class="tip taxType-tip ">请选择产品类型：</p>' +
                    '</div>' +
                    '<div>' +
                    '<label for=" ">套餐税种</label>' +
                    '<select class="default-select taxCategory"></select>' +
                    '<p class="tip taxCategory-tip ">请选择产品类型：</p>' +
                    '</div>' +
                    '<div>' +
                    '<label for=" ">套餐税率</label>' +
                    '<input type="text" name=" " class="comboPrice readonly" readonly>' +
                    '</div>' +
                    '<div>' +
                    '<label for=" ">分成比例：</label>' +
                    '<input type="text" name=" " id="divideRatio" />' +
                    '<p class="tip divideRatio-tip ">请填写分成比例！</p>' +
                    '</div>' +
                    '</div>';
                $('.new-add-product .combo-list-wrap').append(str);
                $('.remove-combo').click(function () {
                    $(this).parents('.combo-list').remove();
                })
                /* 产品税目 */
                creatTax()
            })

            /* 产品状态 */
            ajaxAPI('../common/listProductStatus', {}, function (res) {
                var options = '';
                res.data.unshift({
                    id: 4, value: '全部'
                })
                for (var i = 0; i < res.data.length; i++) {
                    options += '<option value=" ' + res.data[i].id + ' ">' + res.data[i].value + '</option>'
                }
                $('#product-status').append(options)
            });

            /* 产品类型 */
            ajaxAPI('../common/listProductType', {}, function (res) {
                var options = '';
                for (var i = 0; i < res.data.length; i++) {
                    options += '<option value="' + res.data[i].id + '">' + res.data[i].value + '</option>'
                }
                $('#product-type').append(options)
                $('.form-productType').append(options)
            });

            /* 查询 */
            $('#product-search').click(function () {
                var productName = $('#product-name').val()
                var productCode = $('#product-code').val()
                creatTable({
                    'productName': productName,//产品名称
                    'productCode': productCode,//产品代码
                    'productStatus': $('#product-status').val() == 4 ? '' : $('#product-status').val(),//产品状态
                    'productType': $('#product-type').val()//产品类型
                });
            });



            /* 新增 */
            $('.options-add').click(function () {
                var type = $(this).attr('type');
                $('.formDiv input[type="text"]').val('');
                $('.productNumber-wrap').hide();
                $('.tip').hide();
                $('.save-btn').attr('type', type).attr('opration', 'add');
                $('.combo-list-wrap').empty();
                // 0:新增产品；1：新建组合产品
                if (type == '0') {
                    $('.save-btn').text('新建产品');
                    $('.pop-header-box').text('新建产品');

                    var str = '<div class="formDiv combo-list">' +
                        '<div>' +
                        '<label>套餐名称：</label>' +
                        '<input type="text" name=" " class="comboName" maxlength="20 ">' +
                        '<p class="tip comboName-tip">套餐名称不能为空！</p>' +
                        '</div>' +
                        '<div>' +
                        '<label>套餐代码：</label>' +
                        '<input type="text" name=" " class="comboCode" maxlength="20 ">' +
                        '<p class="tip comboCode-tip">套餐代码不能为空！</p>' +
                        '</div>' +
                        '<div>' +
                        '<label>套餐价格：</label>' +
                        '<input type="text" name=" " class="comboPrice">' +
                        '<p class="tip comboPrice-tip">产品价格不能为空！</p>' +
                        '</div>' +
                        '<div>' +
                        '<label for=" ">套餐税目</label>' +
                        '<select class="default-select taxType" id="taxType"></select>' +
                        '<p class="tip taxType-tip ">请选择产品类型：</p>' +
                        '</div>' +
                        '<div>' +
                        '<label for=" ">套餐税种</label>' +
                        '<select class="default-select taxCategory"></select>' +
                        '<p class="tip taxCategory-tip ">请选择产品类型：</p>' +
                        '</div>' +
                        '<div>' +
                        '<label for=" ">套餐税率</label>' +
                        '<input type="text" name=" " class="comboPrice readonly" readonly>' +
                        '</div>' +
                        '<div>' +
                        '<label for=" ">分成比例：</label>' +
                        '<input type="text" name=" " id="divideRatio" />' +
                        '<p class="tip divideRatio-tip ">请填写分成比例！</p>' +
                        '</div>' +
                        '</div>';
                    $('.combo-list-wrap').append(str);

                    /* 产品税目 */
                    creatTax()
                } else {
                    $('.save-btn').text('新建组合产品');
                    $('.pop-header-box').text('新建组合产品');
                    $('.new-combination-product .combo-list-wrap').empty()
                    var str = '<div class="formDiv combo-list">' +
                        '<div>' +
                        '<label>产品：</label>' +
                        '<input type="text" name=" " id="combination-product-drop" class="comboName default-select"  style="padding-left: 50px;">' +
                        '</div>' +
                        '<div>' +
                        '<label>套餐：</label>' +
                        '<div class="dropdwon" id="combination-product-combo">' +
                        '<div class="dropdwon-header default-select" style="padding-left: 50px;"></div>' +
                        '<ul></ul>' +
                        '</div>' +
                        '</div>' +
                        '</div>'
                    $('.combo-list-wrap').append(str);

                    productAndCombo('')
                }
                $('.remove-combo').click(function () {
                    $(this).parents('.combo-list').remove();
                });

                showPop();

            })

            /* 保存新增/修改 */
            $('.save-btn').click(function () {
                var regionCode = $('#regionCode').attr('selectid');//区域代码
                var productName = $('#productName').val();//产品名称
                var productStatus = 0;//产品状态
                var productType = $('#productType').val();//产品类型
                var endDate = $('#endDate').val().split('-');//产品类型
                var auditorId = $('#auditor').attr('selectid');//审核人ID
                var auditor = $('#auditor').val();//审核人ID
                var supplierId = $('#supplier').attr('selectid');//供应商

                // 新建产品
                var ComboStr = [];
                // 新建组合产品
                var comboIds = '';


                var type = $(this).attr('type');

                var comboNameList = $('.combo-list');

                if (comboNameList.length > 0) {
                    if (type == '0') {
                        for (var i = 0; i < comboNameList.length; i++) {
                            var comboId = $(comboNameList[i]).attr('comboId');
                            var comboName = $(comboNameList[i]).find('.comboName').val();
                            var comboCode = $(comboNameList[i]).find('.comboCode').val();
                            var comboPrice = $(comboNameList[i]).find('.comboPrice').val();
                            var taxType = $(comboNameList[i]).find('.taxType').val();
                            var taxCategory = $(comboNameList[i]).find('.taxCategory').val();
                            var divideRatio = $(comboNameList[i]).find('#divideRatio').val();//分成比例

                            var em = isEmpty({
                                comboName: comboName,//套餐名称
                                comboCode: comboCode,//套餐代码
                                comboPrice: comboPrice,//套餐价格
                                taxType: taxType,//税目
                                taxCategory: taxCategory,//税种
                                divideRatio: divideRatio,
                            });
                            if (divideRatio) {
                                if (divideRatio < 0) {
                                    showTip('分成比例只能填写正整数！')
                                    return
                                } else if (isNaN(divideRatio)) {
                                    showTip('分成比例只能填写正整数！')
                                    return
                                }
                            }


                            if (em) {
                                ComboStr.push({
                                    comboName: comboName,//套餐名称
                                    comboCode: comboCode,//套餐代码
                                    comboPrice: comboPrice,//套餐价格
                                    taxType: taxType,//税目
                                    taxCategory: taxCategory,//税种
                                    comboId: comboId,
                                    divideRatio: divideRatio,
                                })
                            }

                        }
                    } else {
                        debugger
                        for (var i = 0; i < comboNameList.length; i++) {
                            var multichoose = $(comboNameList[i]).find('.dropdwon').attr('multichoose')
                            if (multichoose && multichoose != '') {
                                if (i == (comboNameList.length - 1)) {
                                    comboIds += $(comboNameList[i]).find('.dropdwon').attr('multichoose')
                                } else {
                                    comboIds += $(comboNameList[i]).find('.dropdwon').attr('multichoose') + ','
                                }
                            } else {
                                showTip('请选择套餐！');
                                return
                            }
                        }
                    }

                } else {
                    showTip('至少要有一个' + (type == '0' ? '套餐' : '组合产品') + '！')
                }

                var notEmpty = isEmpty({
                    'regionCode': regionCode,
                    'productName': productName,//产品名称
                    'endDate': $('#endDate').val(),//产品类型
                    'auditor': auditor,
                    'supplier': supplierId
                })
                var data = {
                    'regionCode': regionCode,
                    'productName': productName,//产品名称
                    'productStatus': 0,
                    'productType': productType,//产品类型
                    'endDate': endDate[0] + '/' + endDate[1] + '/' + endDate[2],
                    'auditorId': auditorId,
                    'comboStr': JSON.stringify(ComboStr),
                    'comboIds': comboIds,
                    'combStatus': 0,
                    'supplierId': supplierId
                }
                if (notEmpty && ComboStr.length > 0 && ComboStr.length == comboNameList.length) {
                    var url = '';
                    var type = $(this).attr('opration');
                    if (type == 'add') {
                        url = '../product/info/save';
                        var text = '添加成功！'
                    } else {
                        url = '../product/info/update';
                        data['productId'] = $(this).attr('productId')
                        var text = '修改成功！'
                    }
                    ajaxPostAPI(url, data, function (res) {
                        if (res.success) {
                            creatTable();
                            hideMyPop();
                            showTip(text)
                        }
                    })
                }
            });


            $('.cancel-btn').click(function () {
                hidePop()
            })


            // 删除产品
            $('.options-delete').click(function () {
                var ids = [];
                var flag = [];
                var status = [];
                var len = $('.checkbox-single input:checked').length;
                if (len > 0) {
                    for (var i = 0; i < len; i++) {
                        var id = $($('.checkbox-single input:checked')[i]).parents('tr').attr('productId');
                        ids.push(id)
                        var Flag1 = $($('.checkbox-single input:checked')[i]).parents('tr').find('.deleteFlag').text();
                        flag.push(Flag1)
                        var status1 = $($('.checkbox-single input:checked')[i]).parents('tr').find('.productStatus').attr('status');
                        status.push(status1)
                    }
                    var deleteFlag = $.inArray('0', flag);
                    var statusXX = $.inArray('2', status);
                    if (deleteFlag == "-1" && statusXX == '-1') {
                        ajaxPostAPI('../product/info/delete', {
                            'ids': ids.toString(),
                        }, function (data) {
                            if (data.success) {
                                creatTable();
                                showTip('删除成功！')
                            }
                        })
                    } else {
                        showTip('已删除的不能再次选择！！！且只能删除已下线的产品');
                    }

                } else {
                    showTip('请选择要删除的产品！')
                }
            });
            // 恢复产品
            $('.options-recover').click(function () {
                var ids = [];
                var len = $('.checkbox-single input:checked').length;
                if (len > 0) {
                    for (var i = 0; i < len; i++) {
                        var flagStatus = $($('.checkbox-single input:checked')[i]).parents('tr').attr('deleteflag');
                        var id = $($('.checkbox-single input:checked')[i]).parents('tr').attr('productId');
                        if (flagStatus != 0) {
                            showTip('只能选择已删除的产品');
                            return
                        } else {
                            ids.push(id)
                        }
                    }
                    ajaxPostAPI('../product/info/recover', {
                        'ids': ids.toString(),
                    }, function (data) {
                        if (data.success) {
                            creatTable();
                            showTip('恢复成功！')
                        }
                    })

                } else {
                    showTip('请选择要恢复的产品！')
                }
            });




            //提供给修改使用，方便select默认值
            var taxTypeData = [];//记录税种
            var taxCategoryData = [];//记录税目



            function creatOptions(data) {
                var op = '';
                for (var i = 0; i < data.length; i++) {
                    op += '<option value="' + data[i].id + '">' + data[i].value + '</option>'
                }

                return op;
            }

            // 产品上线
            $('.options-online').click(function () {
                var ids = [];
                var len = $('.checkbox-single input:checked').length;
                if (len > 0) {
                    for (var i = 0; i < len; i++) {
                        var id = $($('.checkbox-single input:checked')[i]).parents('tr').attr('productId');
                        var parent = $($('.checkbox-single input:checked')[i]).parents('tr');
                        if (parent.find('.productStatus').attr('status') != 0) {
                            showTip('只有下线产品才可以上线！')
                            return
                        }
                        ids.push(id)
                    }
                    ajaxPostAPI('../product/info/online', {
                        'ids': ids.toString(),
                    }, function (data) {
                        if (data.success) {
                            creatTable();
                            showTip('上线成功！')
                        }
                    })
                } else {
                    showTip('请选择要上线的产品！')
                }
            });

            // 产品下线
            $('.options-outline').click(function () {
                var ids = [];
                var len = $('.checkbox-single input:checked').length;
                if (len > 0) {
                    for (var i = 0; i < len; i++) {
                        var id = $($('.checkbox-single input:checked')[i]).parents('tr').attr('productId');
                        var parent = $($('.checkbox-single input:checked')[i]).parents('tr');
                        if (parent.find('.productStatus').attr('status') == 0) {
                            showTip('只有上线产品才可以下线！')
                            return
                        }
                        ids.push(id)
                    }
                    ajaxPostAPI('../product/info/offline', {
                        'ids': ids.toString(),
                    }, function (data) {
                        if (data.success) {
                            creatTable();
                            showTip('下线成功！')
                        }
                    })
                } else {
                    showTip('请选择要下线的产品！')
                }
            });



            // 新建组合产品
            // 产品下拉
            var getProduct = []
            var getCombo = {}
            ajaxAPI('../common/listProductCombo', {}, function (res) {
                getProduct = res.data.product;
                getCombo = res.data.combo;
                productAndCombo('')
            }, false)


            // combination-product-combo
            var addCombo = 0
            $('.new-combination-product .combo-add').click(function () {
                addCombo++
                $('save-btn').attr('type', 'add')
                var str = '<div class="formDiv combo-list">' +
                    '<div><img src="./img/Icon-delet.png" class="remove-combo"></div>' +
                    '<div>' +
                    '<label>产品：</label>' +
                    '<input type="text" name=" " id="combination-product-drop' + addCombo + '" class="comboName default-select">' +
                    '</div>' +
                    '<div>' +
                    '<label>套餐：</label>' +
                    '<div class="dropdwon" id="combination-product-combo' + addCombo + '">' +
                    '<div class="dropdwon-header default-select"></div>' +
                    '<ul></ul>' +
                    '</div>' +
                    '</div>' +
                    '</div>'
                $('.new-combination-product .combo-list-wrap').append(str);
                $('.remove-combo').click(function () {
                    $(this).parents('.combo-list').remove();
                });
                productAndCombo(addCombo)
            })

            var selectedProducts = {};//验证产品是否重复
            function productAndCombo(addCombo, defaultCombo) {
                var dropId = '#combination-product-combo' + addCombo;

                if (defaultCombo) {
                    dropdwon({
                        id: dropId,
                        data: getCombo[defaultCombo.id],
                        multi: true,
                        defaultItem: defaultCombo.defaultCombo
                    });
                }

                $.selectSuggest('combination-product-drop' + addCombo, getProduct, '', function (id, value, self) {
                    var parent = self.parents('.combo-list');
                    var hasSelectedId = parent.attr('product');//用于判断是否选择过产品
                    $(dropId).find('.dropdwon-header').empty();
                    if (hasSelectedId != id) {
                        delete selectedProducts[hasSelectedId]
                        if (hasSelectedId) {
                            delete selectedProducts[parent.attr('hasProductId')]
                            selectFn()
                        } else {
                            selectFn()
                        }
                    }

                    function selectFn() {
                        if (selectedProducts.hasOwnProperty(id)) {
                            showTip('您选择得产品已存在！请选择其他产品！');
                        } else {
                            parent.attr('product', id);
                            selectedProducts[id] = [];
                            dropdwon({
                                id: dropId,
                                data: getCombo[id],
                                multi: true,
                            });

                        }
                    }

                });
            }




            $('.combination-save-btn').click(function () {
                var regionCode = $('#combination-regionCode').attr('selectid');//区域代码
                var productName = $('#combination-productName').val();//产品名称
                var productType = $('#combination-productType').val();//产品类型
                var endDate = $('#combination-endDate').val().split('-');//产品类型

                var comboNameList = $('.new-combination-product .combo-list');
                for (var i = 0; i < comboNameList.length; i++) {
                    var multichoose = $(comboNameList[i]).find('.dropdwon').attr('multichoose')
                    if (multichoose && multichoose != '') {
                        if (i == (comboNameList.length - 1)) {
                            comboIds += $(comboNameList[i]).find('.dropdwon').attr('multichoose')
                        } else {
                            comboIds += $(comboNameList[i]).find('.dropdwon').attr('multichoose') + ','
                        }
                    } else {
                        showTip('请选择套餐！');
                        return
                    }
                }

                if (comboIds == '') {
                    showTip('至少要有一个组合产品！')
                }

                var data = {
                    'regionCode': regionCode,
                    'productName': productName,//产品名称
                    'productType': productType || '',//产品类型
                    'endDate': endDate[0] + '/' + endDate[1] + '/' + endDate[2],
                    'comboIds': comboIds,
                    'combStatus': 1
                }
                var notEmpty = isEmpty({
                    'combination-regionCode': regionCode,
                    'combination-productName': productName,
                })
                if (notEmpty && comboIds != '') {
                    var url = '';
                    var type = $(this).attr('type');
                    if (type == 'add') {
                        url = '../product/info/save';
                        var text = '添加组合产品成功！'
                    } else {
                        url = '../product/info/update';
                        data['productId'] = $(this).attr('productId');

                        var text = '修改组合产品成功！'
                    }
                    ajaxPostAPI(url, data, function (res) {
                        if (res.success) {
                            creatTable();
                            hideMyPop();

                            showTip(text)
                        }
                    })
                }
            });



            /* ----------------------------------------- */

            function creatTable(data) {
                var ajaxData = data ? data : {}

                ajaxAPI('../product/info/list', ajaxData, function (res) {
                    comboList = []
                    var data = res.data.result;
                    var productStatus = ['未上线', '审核中', '不通过', '已上线', '已下线'];
                    var productStatusColor = ['have-not', 'checking', 'not-passed', 'already', 'already-dwon'];
                    var productAnimate = ['have-not', 'checking', 'not-passed', 'already', 'already-dwon'];

                    $('.page span:nth-child(1)').text(res.data.pageNo);
                    $('.page span:nth-child(2)').text(res.data.totalPages);
                    $('.all-counts').text(res.data.totalCount)

                    table({
                        id: '#product-table',
                        thead: ['产品编号', '地区编号', '产品名称', '产品状态', '产品类型', '截至日期', '套餐详情', '是否为组合产品', ''],
                        tbody: function () {
                            var tds = '';
                            for (var i = 0; i < data.length; i++) {
                                tds +=
                                    '<tr class="status ' + productStatusColor[data[i].productStatus] + '" productId="' + data[i].productId + '" combo="' + i + '" auditorId="' + data[i].auditorId + '" deleteFlag="' + data[i].deleteFlag + '">' +
                                    '<td class="product-code"><div class="status had-deleted"></div>' + data[i].productCode + '</td>' +
                                    '<td class="regionCode">' + data[i].regionCode + '</td>' +
                                    '<td class="productName">' + data[i].productName + '</td>' +
                                    '<td class="productStatus" status="' + data[i].productStatus + '"><span class="product-status ' + productStatusColor[data[i].productStatus] + ' "></span>' + data[i].productStatusName + '</td>' +
                                    '<td class="productType" type="' + data[i].productType + '">' + data[i].productTypeName + '</td>' +
                                    '<td class="endTime"><p>' + transitionDate(data[i].endDate) + '</p>' +
                                    (data[i].outOfDate ? '<p class="stop ">已截止</p>' : '') +
                                    '</td > ' +
                                    '<td class="clientPhone ">' + (data[i].comboList.length > 0 ? '<p class="combo-btn" combo="' + i + '">' + data[i].comboList[0].comboName + '</p>' : '无套餐') + '</td>' +
                                    '<td class="deleteFlag" style="display:none">' + data[i].deleteFlag + '</td>' +
                                    '<td class="deleteFlag">' + (data[i].combStatus == 1 ? '组合产品' : '非组合产品') + '</td>' +
                                    '<td>' +
                                    (data[i].deleteFlag == 1 ? '<img class="options-edit" productId="' + data[i].productId + '"  type="' + (data[i].combStatus == 1 ? 'new-combination-product' : 'new-add-product') + '" src="./img/Icon-edit.png" alt="" title="编辑">' : '已删除') +
                                    // '<img class="options-edit" src="./img/Icon-edit.png" alt="" title="编辑">' +
                                    // '<img class="options-recover" src="./img/recover.png" alt="" title="恢复">' +
                                    '</td>' +
                                    '</tr>';
                                comboList.push(data[i].comboList)
                            }
                            return tds;
                        }
                    });
                    //产品修改
                    $('.options-edit').click(function () {

                        var productId = $(this).attr('productId')
                        var showPopName = '.' + $(this).attr('type');
                        showMyPop(showPopName);
                        $('.save-btn').text('修改产品').attr('type', 'edit').attr('productId', productId);
                        $('.combination-save-btn').text('修改组合产品').attr('type', 'edit').attr('productId', productId);

                        $('.new-add-product .pop-header-box').text('修改产品')
                        $('.new-combination-product .pop-header-box').text('修改组合产品')
                        $('.productNumber-wrap').hide();
                        $('.tip').hide();
                        $('.productNumber-wrap').show();

                        ajaxAPI('../product/info/edit', { 'productId': productId }, function (res) {
                            var product = res.data;
                            $('.form-productNumber').val(product.productCode);
                            $('.form-areaNumber').attr('defaultSelect', product.regionCode);
                            $('.form-productName').val(product.productName);
                            $('.form-endTime').val(transitionDate(product.endDate));

                            $('.combo-list-wrap').empty();
                            if (showPopName == '.new-add-product') {
                                $('.form-productType option[value="' + product.productType + '"]').attr("selected", "selected");
                                $('.auditor').attr('defaultSelect', product.auditorId);
                                $.selectSuggest('regionCode', createAreas());

                                // 供应商
                                $('#supplier').attr('defaultSelect', product.supplierId);
                                supplier()
                                auditorSearch()
                                // var comboListEdit = comboList[comboIndex]
                                var comboListEdit = res.data.comboList
                                if (comboListEdit.length > 0) {
                                    for (var i = 0; i < comboListEdit.length; i++) {
                                        var str = '<div class="formDiv combo-list" comboId="' + comboListEdit[i].comboId + '">' +
                                            '<div><img src="./img/Icon-delet.png" class="remove-combo"></div>' +
                                            '<div>' +
                                            '<label>套餐名称：</label>' +
                                            '<input type="text" value="' + comboListEdit[i].comboName + '" class="comboName" maxlength="20 ">' +
                                            '<p class="tip comboName-tip">套餐名称不能为空！</p>' +
                                            '</div>' +
                                            '<div>' +
                                            '<label>套餐代码：</label>' +
                                            '<input type="text" value="' + comboListEdit[i].comboCode + '" readOnly class="comboCode readonly" maxlength="20 ">' +
                                            '<p class="tip comboCode-tip">套餐代码不能为空！</p>' +
                                            '</div>' +
                                            '<div>' +
                                            '<label>产品价格：</label>' +
                                            '<input type="text" value="' + comboListEdit[i].comboPrice + '" class="comboPrice">' +
                                            '<p class="tip comboPrice-tip">产品价格不能为空！</p>' +
                                            '</div>' +
                                            '<div>' +
                                            '<label for=" ">产品税目</label>' +
                                            '<select class="default-select taxType taxType' + i + '" id="taxType"  value="' + comboListEdit[i].taxType + '">' + creatOptions(taxTypeData) + '</select>' +
                                            '<p class="tip taxType-tip ">请选择产品类型：</p>' +
                                            '</div>' +
                                            '<div>' +
                                            '<label for=" ">产品税种</label>' +
                                            '<select class="default-select taxCategory taxCategory' + i + '" value="' + comboListEdit[i].taxCategory + '">' + creatOptions(taxCategoryData[comboListEdit[i].taxType]) + '</select>' +
                                            '<p class="tip taxCategory-tip ">请选择产品类型：</p>' +
                                            '</div>' +
                                            '<div>' +
                                            '<label for=" ">产品税率</label>' +
                                            '<input type="text" value="' + comboListEdit[i].taxVal + '" class="comboPrice readonly" readonly>' +
                                            '</div>' +
                                            '<div>' +
                                            '<label for=" ">分成比例：</label>' +
                                            '<input type="text" value="' + comboListEdit[i].divideRatio + '" id="divideRatio" />' +
                                            '<p class="tip divideRatio-tip ">请填写分成比例！</p>' +
                                            '</div>' +
                                            '</div>';
                                        $('.new-add-product .combo-list-wrap').append(str);

                                        $('.taxType' + i).find('option[value="' + comboListEdit[i].taxType + '"]').attr('selected', 'selected')
                                        $('.taxCategory' + i).find('option[value="' + comboListEdit[i].taxCategory + '"]').attr('selected', 'selected')

                                    }

                                    $('.taxType').change(function () {
                                        $(this).parent('div').next('div').find('.taxCategory').empty()
                                        var data = taxCategoryData[$(this).val()];
                                        if (data.length == 0) {
                                            $(this).parent('div').next('div').find('.taxCategory').val('无选项')
                                        } else {
                                            var op = ''
                                            for (var i = 0; i < data.length; i++) {
                                                op += '<option value="' + data[i].id + '">' + data[i].value + '</option>'
                                            }
                                            $(this).parent('div').next('div').find('.taxCategory').append(op);
                                        }
                                    })

                                    $('.remove-combo').click(function () {
                                        $(this).parents('.combo-list').remove();
                                    })
                                }
                            } else {

                                $.selectSuggest('combination-regionCode', createAreas());
                                var productCombo = res.data.comboMap;

                                for (var key in productCombo) {
                                    var str = '<div class="formDiv combo-list" product="' + key + '">' +
                                        '<div><img src="./img/Icon-delet.png" class="remove-combo"></div>' +
                                        '<div>' +
                                        '<label>产品：</label>' +
                                        '<input type="text" name=" " defaultSelect="' + key + '" id="combination-product-drop' + key + '" class="comboName default-select">' +
                                        '</div>' +
                                        '<div>' +
                                        '<label>套餐：</label>' +
                                        '<div class="dropdwon" id="combination-product-combo' + key + '" multichoose="' + productCombo[key].toString() + '">' +
                                        '<div class="dropdwon-header default-select"></div>' +
                                        '<ul></ul>' +
                                        '</div>' +
                                        '</div>' +
                                        '</div>';
                                    $('.new-combination-product .combo-list-wrap').append(str);
                                    $('.remove-combo').click(function () {
                                        var product = $(this).parents('.combo-list').attr('product');
                                        delete selectedProducts[product]
                                        $(this).parents('.combo-list').remove();
                                    });
                                    selectedProducts[key] = [];//验证产品是否重复

                                    productAndCombo(key, {
                                        id: key,
                                        defaultCombo: productCombo[key]
                                    })
                                }


                            }
                        })

                    })


                    // 详情
                    $('.combo-btn').click(function (e) {
                        e.stopPropagation();
                        var comboIndex = $(this).attr('combo')
                        creatCombo(comboList[comboIndex])
                    });


                }, false)

            };
            function creatCombo(data) {
                $('#combo-detail > .combo-detail-con').empty();
                $('.combo-detail').addClass('show-detail');
                var tds = '';
                for (var i = 0; i < data.length; i++) {
                    tds +=
                        '<div class="combo ">' +
                        '<h4 class="product ">' + data[i].comboName + '</h4>' +
                        '<ul>' +
                        '<li class="productName1 ">产品价格<span class="productPrice1 ">' + data[i].comboPrice + '</span>' + '</li>' +
                        '<li class="productName2 ">产品税目<span class="productPrice2 ">' + data[i].taxTypeName + '</span>' + '</li>' +
                        '<li class="productName3 ">产品品种<span class="productPrice3 ">' + data[i].taxCategoryName + '</span>' + '</li>' +
                        '<li class="productName3 ">产品税率<span class="productPrice3 ">' + data[i].taxVal + '</span>' + '</li>' +
                        '</ul>' +
                        '</div>';
                }
                $('#combo-detail > .combo-detail-con').append(tds)
            }
            function creatTax() {
                /* 产品税目 */
                ajaxAPI('../common/listTaxCategory', {}, function (res) {
                    var taxType = res.data.taxType;
                    var taxCategory = res.data.taxCategory;
                    var taxTypeOption = '';
                    taxTypeData = res.data.taxType;
                    taxCategoryData = res.data.taxCategory;
                    for (var i = 0; i < taxType.length; i++) {
                        taxTypeOption += '<option value="' + taxType[i].id + '">' + taxType[i].value + '</option>'
                    }
                    $('.taxType').append(taxTypeOption);
                    $('.taxType').change(function () {
                        $(this).parent('div').next('div').find('.taxCategory').empty()
                        var data = taxCategory[$(this).val()];
                        if (data.length == 0) {
                            $(this).parent('div').next('div').find('.taxCategory').val('无选项')
                        } else {
                            var op = ''
                            for (var i = 0; i < data.length; i++) {
                                op += '<option value="' + data[i].id + '">' + data[i].value + '</option>'
                            }
                            $(this).parent('div').next('div').find('.taxCategory').append(op);
                        }
                    })
                });
            }

            //审批人模糊搜索
            function auditorSearch() {
                ajaxAPI('../common/listAuditorUser', {}, function (res) {
                    $.selectSuggest('auditor', res.data);
                })
            }




            /* -------------------------------------- */

        })


    </script>

</body>

</html>