<!DOCTYPE html>
<html lang="zh-CH">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>用户管理</title>
    <link rel="stylesheet" href="./css/userManagement.css">
</head>

<body>
    <div class="box">
        <div class="box-con">
            <div class="box-header">
                <p>
                    <span>用户信息</span>
                    <span>
                        <span class="all-counts"></span> Product</span>
                </p>
            </div>
            <div class="options-system">
                <img src="./img/Icon-add.png" type="0" class="options-add-group" alt="" title="新增" />
                <img src="./img/Icon-delet.png" class="options-delete-group" alt="" title="删除" />
            </div>
            <div class="colum-2 colum-2-system">
                <div>
                    <div class="options-system">
                        <img src="./img/Icon-add.png" type="0" class="options-add-group" alt="" title="新增" />
                        <img src="./img/Icon-delet.png" class="options-delete-group" alt="" title="删除" />
                    </div>
                    <div id="user-group-table"></div>
                </div>
                <div>
                    <div>
                        <div class="formDiv add-group-user">
                            <div>
                                <label for="">企业组名称：</label>
                                <input type="text" name="" id="groupName" placeholder="" style="padding-left: 80px">
                                <p class="tip groupName-tip">企业组名称不能为空！</p>
                            </div>
                            <div class="multi-search-group">
                                <div>
                                    <div class="multi-search">
                                        <span>选择用户：</span>
                                        <p class="multi-input default-select" id="select-user" chooseid=""></p>
                                        <div class="multi-search-con" style="display:none">
                                            <input type="text" id="list-user">
                                        </div>
                                    </div>
                                    <p class="tip select-user-tip">用户不能为空！</p>
                                </div>
                                <div>
                                    <div class="multi-search">
                                        <span>选择产品：</span>
                                        <p class="multi-input default-select" id="select-product" chooseid=""></p>
                                        <div class="multi-search-con" style="display:none">
                                            <input type="text" id="list-product">
                                        </div>
                                    </div>
                                    <p class="tip select-product-tip">产品不能为空！</p>
                                </div>
                            </div>

                        </div>
                        <div class="text-right">
                            <button class="btn btn-blue save-user-group">确定</button>
                            <button class="btn btn-green cancel-user-group">取消</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="./js/jquery.selectMulti.js"></script>

    <script>
        $(function () {

            // 用户组管理
            creatUserGroupTable()

            $('#select-user').click(function (e) {
                e.stopPropagation();
                $('.multi-search-con').hide();
                $(this).next('.multi-search-con').show();
                $(this).next('.multi-search-con').find('.dim-search').show();
                var _this = $(this)
                ajaxAPI('../common/listUser', {}, function (res) {
                    $.selectSuggestMulti('list-user', res.data, _this);
                }, false)
            });

            $('#select-product').click(function (e) {
                e.stopPropagation();
                $('.multi-search-con').hide();
                $(this).next('.multi-search-con').show();
                $(this).next('.multi-search-con').find('.dim-search').show();
                var _this = $(this)
                ajaxAPI('../common/listProduct', {}, function (res) {
                    $.selectSuggestMulti('list-product', res.data, _this);
                }, false)
            });

            $('.options-add-group').click(function () {
                $('#groupName').val('');
                $('#select-user').attr('chooseId', '');
                $('#select-product').attr('chooseId', '');
                $('.multi-input').empty();

                $('.add-group-user').show();
                $('.save-user-group').attr('type', 'add');
            })

            $('.save-user-group').click(function () {
                var type = $(this).attr('type')
                var groupName = $('#groupName').val();
                var userIds = $('#select-user').attr('chooseId');
                var productIds = $('#select-product').attr('chooseId');
                if (groupName == '') {
                    $('.groupName-tip').show()
                } else {
                    $('.groupName-tip').hide()
                }
                if (userIds == '') {
                    $('.select-user-tip').show()
                } else {
                    $('.select-user-tip').hide()
                }
                if (productIds == '') {
                    $('.select-product-tip').show()
                } else {
                    $('.select-product-tip').hide()
                }

                if (groupName != '' && userIds != '' && productIds != '') {
                    var data = { 'groupName': groupName, 'userIds': userIds, 'productIds': productIds }
                    if (type == 'add') {
                        url = '../system/group/save';
                        var text = '用户组添加成功！'
                    } else {
                        url = '../system/group/update';
                        var text = '用户组修改成功！';
                        data['groupId'] = $('#groupName').attr('groupId');
                    }
                    ajaxPostAPI(url, data, function (res) {
                        if (res.success) {
                            showTip(text)
                            creatUserGroupTable();
                        }
                    })
                }

            })
            $('.cancel-user-group').click(function () {
                $('.tip').hide();
                $('#groupName').val('');
                $('#select-user').attr('chooseId', '');
                $('#select-product').attr('chooseId', '');
                $('.multi-input').empty();
                // hidePop()
            })
            /* 删除用户组 */
            $('.options-delete-group').click(function () {
                var ids = [];
                var flag = new Array();
                var trSelected = $('#user-group-table tbody').find('input:checked');
                if (trSelected.length == 0) {
                    showTip('请选择要删除的用户组！');
                } else {
                    for (var i = 0; i < trSelected.length; i++) {
                        ids.push($(trSelected[i]).parents('tr').attr('userGroupId'));
                    }
                    ajaxPostAPI('../system/group/delete', { 'ids': ids.toString() }, function (res) {
                        if (res.success) {
                            showTip('删除成功！')
                            creatUserGroupTable();
                        }
                    })
                }
            });


        });
        function creatUserGroupTable() {
            ajaxAPI('../system/group/list', {}, function (res) {
                var data = res.data.result;
                table({
                    id: '#user-group-table',
                    thead: ['用户组', '',],
                    tbody: function () {
                        var tds = '';
                        var list = [];
                        for (var i = 0; i < data.length; i++) {
                            tds +=
                                '<tr userGroupId="' + data[i].groupId + '">' +
                                '<td class="userName">' + data[i].groupName + '</td>' +
                                '<td>' +
                                (data[i].deleteFlag == 0 ? '<img src="./img/recover.png" class="options-recover-group" userGroupId="' + data[i].groupId + '" alt="">' : '<img src="./img/Icon-edit.png" class="options-edit-group" userGroupId="' + data[i].groupId + '" alt="">') +
                                '</td>' +
                                '</tr>'
                        }
                        return tds;
                    }
                });
                $('.options-recover-group').click(function () {
                    var ids = [];
                    ids.push($(this).attr('userGroupId'));
                    ajaxPostAPI('../system/group/recover', { 'ids': ids.toString() }, function (res) {
                        if (res.success) {
                            showTip('恢复成功！')
                            creatUserGroupTable();
                        }
                    })
                });
                $('.options-edit-group').click(function () {
                    $('.multi-input').empty();

                    $('.save-user-group').attr('type', 'edit');
                    var groupId = $(this).attr('userGroupId');
                    ajaxAPI('../system/group/edit', { 'groupId': groupId }, function (res) {
                        $('.add-group-user').show();
                        $('#groupName').val(res.data.group.groupName).attr('groupId', res.data.group.groupId);
                        // var groupName = $('#groupName').val();
                        // var userIds = $('#select-user').attr('chooseId');
                        // var productIds = $('#select-product').attr('chooseId');
                        var userIds = res.data.userIds
                        var productIds = res.data.productIds
                        ajaxAPI('../common/listUser', {}, function (res) {
                            $.selectSuggestMulti('list-user', res.data, $('#select-user'), userIds);
                        }, false)
                        ajaxAPI('../common/listProduct', {}, function (res) {
                            $.selectSuggestMulti('list-product', res.data, $('#select-product'), productIds);
                        }, false)
                    })
                })
            })
        }
    </script>
</body>

</html>